import {GiveWarningAlert, GiveErrorAlert, GiveConfirmModal, GiveSuccessAlert, GiveFormModal} from '../plugins/modal';

jQuery.noConflict();

class Deactivation_Survey {

	constructor() {
		window.addEventListener(
			'load',
			function() {
				window.addDynamicEventListener( document, 'click', 'tr[data-slug="give"] .deactivate a', Deactivation_Survey.deactivate_give );
				window.addDynamicEventListener( document, 'click', 'input[name="give-survey-radios"]', Deactivation_Survey.toggle_additional_fields );
			}
		);
	}

	static deactivate_give( e ) {

		e.preventDefault();

		let deactivation_link = e.target.href;

		jQuery.ajax({
			url: ajaxurl,
			type: 'POST',
			data: {
				'action': 'deactivation_popup',
			}
		}).done( function( response ) {
			new GiveFormModal({
				classes: {
					modalWrapper: 'deactivation-survey-wrap',
				},

				modalContent:{
					desc: response,
					cancelBtnTitle: give_vars.cancel,
					confirmBtnTitle: give_vars.submit_and_deactivate,
				},

				successConfirm: function( args ) {

					// Deactivation Error admin notice.
					let deactivation_error = document.querySelectorAll( '.deactivation-error' );
					let checked_radio      = document.querySelectorAll( 'input[name="give-survey-radios"]:checked' );
					let survey_form        = document.querySelectorAll( '.deactivation-survey-form' );
					let continue_flag      = true;

					if ( deactivation_error.length > 0 ) {

						continue_flag = false;

					}

					// If no radio button is selected then throw error.
					if ( 0 === checked_radio.length && 0 === deactivation_error.length ) {

						survey_form[0].innerHTML += `
							<div class="notice notice-error deactivation-error">
								${give_vars.deactivation_no_option_selected}
							</div>
						`;

						continue_flag = false;
					}

					/* If a radio button is assosciated with additional field
					 * and if that field is empty, then throw error.
					 */
					let user_reason_field = '';

					if ( checked_radio.length > 0 && null !== checked_radio[0].parentNode.nextElementSibling ) {
						user_reason_field = checked_radio[0]
							.parentNode
							.nextElementSibling
							.querySelectorAll( 'input, textarea' );

						if ( 0 < user_reason_field.length && ! user_reason_field[0].value && 0 === deactivation_error.length ) {

							let error_node = document.createElement( 'div' );
							error_node.setAttribute( 'class', 'notice notice-error deactivation-error' );

							let text_node = document.createTextNode( give_vars.please_fill_field );

							error_node.appendChild( text_node );
							survey_form[0].appendChild( error_node );

							continue_flag = false;

						} else if ( 0 < user_reason_field.length && user_reason_field[0].value ) {

							if ( 0 !== deactivation_error.length ) {
								deactivation_error[0].parentNode.removeChild( deactivation_error[0] );
								continue_flag = true;
							}
						}
					}

					/**
					 * If form is properly filled, then serialize form data and
					 * pass it to the AJAX callback for processing.
					 */
					if ( continue_flag ) {

						let form_data = jQuery('.deactivation-survey-form').serialize();

						jQuery.ajax({
							url: ajaxurl,
							type: 'POST',
							data: {
								'action': 'deactivation_form_submit',
								'form-data': form_data,
							},
							beforeSend: function() {
								let spinner = document.querySelectorAll( '.give-modal__controls .spinner' );
								spinner[0].style.visibility = 'visible';
							}
						}).done( function( response ) {

							if ( response.success ) {
								if ( response.data.delete_data ) {
									Deactivation_Survey.delete_all_data( 1, form_data );
								}
							}
						});
					}
				}
			}).render();
		});
	}

	/**
	 * Deletes all the data generated by Give plugin.
	 */
	static delete_all_data( step, form_data ) {
		jQuery.ajax({
			url: ajaxurl,
			type: 'POST',
			data: {
				'form': form_data,
				'action': 'give_do_ajax_export',
				'step': step,
			},
			dataType: 'json',
		}).done( function( response ) {
			if ( true !== response.success && ! response.error ) {
				Deactivation_Survey.delete_all_data( parseInt( response.step ), form_data );
			} else if ( true === response.success ) {
				jQuery.magnificPopup.close();
				window.location.replace( deactivation_link );
			}
		});
	}

	static toggle_additional_fields( e ) {
		let deactivation_error = document.querySelectorAll( '.deactivation-error' );
		let extra_field        = document.querySelectorAll( '.give-survey-extra-field' );
		let ef                 = '';

		if ( deactivation_error.length > 0 ) {
			deactivation_error[0].parentNode.removeChild( deactivation_error[0] );
		}

		extra_field.forEach( function( element ) {
			element.style.display = 'none';
			ef                    = element.querySelectorAll( 'input, textarea' );
			ef[0].setAttribute( 'disabled', 'disabled' );
		});

		if ( null !== e.target.parentNode.nextElementSibling ) {
			e.target.parentNode.nextElementSibling.style.display = 'block';
			let ip = e.target.parentNode.nextElementSibling.querySelectorAll( 'input, textarea' );
			ip[0].removeAttribute( 'disabled' );
		}
	}
}

let deactivation_survey = new Deactivation_Survey();